services:
  # ── Mailpit — local mail server for testing ────────
  # SMTP: localhost:1025  POP3: localhost:1110  Web UI: http://localhost:8025
  # REST API: http://localhost:8025/api/v1/messages
  mailpit:
    image: axllent/mailpit:latest
    container_name: broxeen-mailpit
    ports:
      - "1025:1025"   # SMTP (no auth, no TLS)
      - "1110:1110"   # POP3
      - "8025:8025"   # Web UI + REST API
    environment:
      - MP_SMTP_AUTH_ACCEPT_ANY=1
      - MP_SMTP_AUTH_ALLOW_INSECURE=1
    restart: unless-stopped
    profiles:
      - mail

  # ── Production (static build served by 'serve') ────
  broxeen:
    build:
      context: .
      target: production
    ports:
      - "4173:4173"
    restart: unless-stopped
    environment:
      - NODE_ENV=production

  # ── Development (Vite dev server, hot reload) ──────
  broxeen-dev:
    build:
      context: .
      target: dev
    ports:
      - "5173:5173"
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - VITE_OPENROUTER_API_KEY=${VITE_OPENROUTER_API_KEY:-}
      - VITE_LLM_MODEL=${VITE_LLM_MODEL:-}
    profiles:
      - dev

  # ── Tests (vitest) ─────────────────────────────────
  broxeen-test:
    build:
      context: .
      target: test
    environment:
      - CI=true
    profiles:
      - test
